#MASK_LAN_INGRESS="0xFF000002/0xFF00000F"
#MASK_WAN_INGRESS="0xFF000003/0xFF00000F"
#MASK_TUN_INGRESS="0xFF000004/0xFF00000F"
#MARK_LOCAL_FROM_LAN="0xFF121212/0xFFFFFFFF"
#MARK_LOCAL_TO_LAN="0xFF211221/0xFFFFFFFF"
#MARK_LOCAL_FROM_WAN="0xFF021113/0xFFFFFFFF"
#MARK_LOCAL_TO_WAN="0xFF011131/0xFFFFFFFF"
#MARK_LOCAL_FROM_TUN="0xFF021114/0xFFFFFFFF"
#MARK_LOCAL_TO_TUN="0xFF011141/0xFFFFFFFF"
#MARK_LAN_TO_WAN="0xFF222232/0xFFFFFFFF"
#MARK_LAN_FROM_WAN="0xFF112223/0xFFFFFFFF"
#MARK_LAN_TO_TUN="0xFF222342/0xFFFFFFFF"
#MARK_LAN_FROM_TUN="0xFF112324/0xFFFFFFFF"

IPSET:
    requires:
        - {'name': 'IPS_CIRCULAR_POOL',    'type': 'hash:ip',  'create': true, 'flush': true}
        - {'name': 'IPS_SPOOFED_NET_LAN',  'type': 'hash:net', 'create': true, 'flush': true}
        - {'name': 'IPS_SPOOFED_NET_WAN',  'type': 'hash:net', 'create': true, 'flush': true}
        - {'name': 'IPS_SPOOFED_NET_TUN',  'type': 'hash:net', 'create': true, 'flush': true}
        - {'name': 'IPS_FILTER_BLACKLIST', 'type': 'hash:ip',  'create': true, 'flush': true}
        - {'name': 'IPS_FILTER_WHITELIST', 'type': 'hash:ip',  'create': true, 'flush': true}
        - {'name': 'IPS_DNS_WHITELIST',    'type': 'hash:ip',  'create': true, 'flush': true}
        - {'name': 'IPS_DNS_BLACKLIST',    'type': 'hash:ip',  'create': true, 'flush': true}
        - {'name': 'IPS_DNS_WKGREYLIST',   'type': 'hash:ip',  'create': true, 'flush': true}
    rules:
        - {'name': 'IPS_CIRCULAR_POOL',    'type': 'ip',  'items': ['100.64.1.133/32', '100.64.1.134/32', '100.64.1.135/32']}
        - {'name': 'IPS_SPOOFED_NET_LAN',  'type': 'net', 'items': ['0.0.0.0/8', '127.0.0.0/8', '10.0.0.0/8', '172.16.0.0/12', '224.0.0.0/3']}
        - {'name': 'IPS_SPOOFED_NET_WAN',  'type': 'net', 'items': ['0.0.0.0/8', '127.0.0.0/8', '10.0.0.0/8', '172.16.0.0/12', '192.168.0.0/16', '224.0.0.0/3']}
        - {'name': 'IPS_SPOOFED_NET_TUN',  'type': 'net', 'items': ['0.0.0.0/8', '127.0.0.0/8', '10.0.0.0/8', '192.168.0.0/16', '224.0.0.0/3']}
        - {'name': 'IPS_FILTER_BLACKLIST', 'type': 'ip',  'items': []}
        - {'name': 'IPS_FILTER_WHITELIST', 'type': 'ip',  'items': []}
        - {'name': 'IPS_DNS_WHITELIST',    'type': 'ip',  'items': []}
        - {'name': 'IPS_DNS_BLACKLIST',    'type': 'ip',  'items': []}
        - {'name': 'IPS_DNS_WKGREYLIST',   'type': 'ip',  'items': []}

IPTABLES:
    PACKET_MARKING:
        requires:
            - {'table': 'mangle', 'chain': 'PREROUTING', 'create': false, 'flush': true}
            - {'table': 'mangle', 'chain': 'FORWARD',    'create': false, 'flush': true}
            - {'table': 'mangle', 'chain': 'INPUT',      'create': false, 'flush': true}
            - {'table': 'mangle', 'chain': 'OUTPUT',     'create': false, 'flush': true}
        rules:
            # Marks in PREROUTING to indicate input interface
            - {'table': 'mangle', 'chain': 'PREROUTING', 'rule': [['in-interface','lan0'], ['target',{'MARK':{'set-mark':'0xFF000002/0xFF00000F'}}], ['comment',{'comment':'MASK_LAN_INGRESS'}]]}
            - {'table': 'mangle', 'chain': 'PREROUTING', 'rule': [['in-interface','wan0'], ['target',{'MARK':{'set-mark':'0xFF000003/0xFF00000F'}}], ['comment',{'comment':'MASK_WAN_INGRESS'}]]}
            - {'table': 'mangle', 'chain': 'PREROUTING', 'rule': [['in-interface','tun0'], ['target',{'MARK':{'set-mark':'0xFF000004/0xFF00000F'}}], ['comment',{'comment':'MASK_TUN_INGRESS'}]]}
            # Marks in FORWARD to indicate input & output interface
            - {'table': 'mangle', 'chain': 'FORWARD',    'rule': [['in-interface','lan0'], ['out-interface','wan0'], ['target',{'MARK':{'set-mark':'0xFF222232/0xFFFFFFFF'}}], ['comment',{'comment':'MARK_LAN_TO_WAN'}]]}
            - {'table': 'mangle', 'chain': 'FORWARD',    'rule': [['in-interface','lan0'], ['out-interface','tun0'], ['target',{'MARK':{'set-mark':'0xFF222342/0xFFFFFFFF'}}], ['comment',{'comment':'MARK_LAN_TO_TUN'}]]}
            - {'table': 'mangle', 'chain': 'FORWARD',    'rule': [['in-interface','wan0'], ['out-interface','lan0'], ['target',{'MARK':{'set-mark':'0xFF112223/0xFFFFFFFF'}}], ['comment',{'comment':'MARK_LAN_FROM_WAN'}]]}
            - {'table': 'mangle', 'chain': 'FORWARD',    'rule': [['in-interface','tun0'], ['out-interface','lan0'], ['target',{'MARK':{'set-mark':'0xFF112324/0xFFFFFFFF'}}], ['comment',{'comment':'MARK_LAN_FROM_TUN'}]]}
            # Marks in INPUT to indicate input interface
            - {'table': 'mangle', 'chain': 'INPUT',      'rule': [['in-interface','lan0'], ['target',{'MARK':{'set-mark':'0xFF121212/0xFFFFFFFF'}}], ['comment',{'comment':'MARK_LOCAL_FROM_LAN'}]]}
            - {'table': 'mangle', 'chain': 'INPUT',      'rule': [['in-interface','wan0'], ['target',{'MARK':{'set-mark':'0xFF021113/0xFFFFFFFF'}}], ['comment',{'comment':'MARK_LOCAL_FROM_WAN'}]]}
            - {'table': 'mangle', 'chain': 'INPUT',      'rule': [['in-interface','tun0'], ['target',{'MARK':{'set-mark':'0xFF021114/0xFFFFFFFF'}}], ['comment',{'comment':'MARK_LOCAL_FROM_TUN'}]]}
            # Marks in OUTPUT to indicate output interface
            - {'table': 'mangle', 'chain': 'OUTPUT',     'rule': [['out-interface','lan0'], ['target',{'MARK':{'set-mark':'0xFF211221/0xFFFFFFFF'}}], ['comment',{'comment':'MARK_LOCAL_TO_LAN'}]]}
            - {'table': 'mangle', 'chain': 'OUTPUT',     'rule': [['out-interface','wan0'], ['target',{'MARK':{'set-mark':'0xFF011131/0xFFFFFFFF'}}], ['comment',{'comment':'MARK_LOCAL_TO_WAN'}]]}
            - {'table': 'mangle', 'chain': 'OUTPUT',     'rule': [['out-interface','tun0'], ['target',{'MARK':{'set-mark':'0xFF011141/0xFFFFFFFF'}}], ['comment',{'comment':'MARK_LOCAL_TO_TUN'}]]}

    mREJECT:
        requires:
            - {'table': 'filter', 'chain': 'mREJECT', 'create': true, 'flush': true}
        rules:
            - {'table': 'filter', 'chain': 'mREJECT', 'rule': [['protocol','1'],  ['target',{'REJECT':{'reject-with':'icmp-admin-prohibited'}}]]}
            - {'table': 'filter', 'chain': 'mREJECT', 'rule': [['protocol','6'],  ['target',{'REJECT':{'reject-with':'tcp-reset'}}]]}
            - {'table': 'filter', 'chain': 'mREJECT', 'rule': [['protocol','17'], ['target',{'REJECT':{'reject-with':'icmp-port-unreachable'}}]]}
            - {'table': 'filter', 'chain': 'mREJECT', 'rule': [['target',{'REJECT':{'reject-with':'icmp-proto-unreachable'}}]]}

    NAT:
        requires:
            - {'table': 'mangle', 'chain': 'PREROUTING',    'create': false, 'flush': false}
            - {'table': 'mangle', 'chain': 'CIRCULAR_POOL', 'create': true,  'flush': true}
            - {'table': 'nat',    'chain': 'PREROUTING',    'create': false, 'flush': true}
            - {'table': 'nat',    'chain': 'POSTROUTING',   'create': false, 'flush': true}
        rules:
            - {'table': 'mangle', 'chain': 'CIRCULAR_POOL', 'rule': [['protocol','6'], ['tcp',{'syn':true}], ['target',{'NFQUEUE':{'queue-num':'1', 'queue-bypass':true}}]]}
            - {'table': 'mangle', 'chain': 'CIRCULAR_POOL', 'rule': [['protocol','1'],                       ['target',{'NFQUEUE':{'queue-num':'1', 'queue-bypass':true}}]]}
            - {'table': 'mangle', 'chain': 'CIRCULAR_POOL', 'rule': [['protocol','17'],                      ['target',{'NFQUEUE':{'queue-num':'1', 'queue-bypass':true}}]]}
            - {'table': 'mangle', 'chain': 'CIRCULAR_POOL', 'rule': [['protocol','132'],                     ['target',{'NFQUEUE':{'queue-num':'1', 'queue-bypass':true}}]]}
            - {'table': 'mangle', 'chain': 'PREROUTING',    'rule': [['mark',{'mark':'0xFF000003/0xFF00000F'}], ['conntrack',{'ctstate':'NEW'}], ['set',{'match-set':['IPS_CIRCULAR_POOL', 'dst']}], ['comment',{'comment':'New connections via CircularPool'}], ['target','CIRCULAR_POOL']]}
            # Check proper matching before doing the MARKDNAT - Packet mark is different than gratuitous
            - {'table': 'nat',    'chain': 'PREROUTING',    'rule': [['mark',{'mark':['!', '0xFF000000/0xFF000000']}],['target',{'MARKDNAT':{'or-mark':'0'}}], ['comment',{'comment':'Do MARKDNAT'}]]}
            # Enable SNAT for MARK_LAN_TO_WAN packets			
            - {'table': 'nat',    'chain': 'POSTROUTING',   'rule': [['mark',{'mark':'0xFF222232/0xFFFFFFFF'}],['target',{'SNAT':{'to-source':'100.64.1.133-100.64.1.135', 'persistent':''}}], ['comment',{'comment':'SNAT to available pool'}]]}

    ADMIN_PREEMPTIVE:
        requires:
            - {'table': 'filter', 'chain': 'ADMIN_PREEMPTIVE', 'create': true,  'flush': true}
            - {'table': 'filter', 'chain': 'INPUT',            'create': false, 'flush': true}
            - {'table': 'filter', 'chain': 'OUTPUT',           'create': false, 'flush': true}
            - {'table': 'filter', 'chain': 'FORWARD',          'create': false, 'flush': true}
        rules:
            - {'table': 'filter', 'chain': 'INPUT',            'rule': [['in-interface','lo'],   ['target', 'ACCEPT']]}
            - {'table': 'filter', 'chain': 'INPUT',            'rule': [['in-interface','mgt0'], ['target', 'ACCEPT']]}
            - {'table': 'filter', 'chain': 'INPUT',            'rule': [['comment', {'comment': 'Continue in ADMIN_PREEMPTIVE'}], ['target', 'ADMIN_PREEMPTIVE']]}
            - {'table': 'filter', 'chain': 'FORWARD',          'rule': [['comment', {'comment': 'Continue in ADMIN_PREEMPTIVE'}], ['target', 'ADMIN_PREEMPTIVE']]}

            - {'table': 'filter', 'chain': 'ADMIN_PREEMPTIVE', 'rule': [['set', {'match-set': ['IPS_FILTER_BLACKLIST', 'src']}], ['comment', {'comment': 'Drop blacklisted sources'}], ['target', 'DROP']]}
            - {'table': 'filter', 'chain': 'ADMIN_PREEMPTIVE', 'rule': [['set', {'match-set': ['IPS_FILTER_WHITELIST', 'src']}], ['comment', {'comment': 'Accept whitelisted sources'}], ['target', 'ACCEPT']]}
            - {'table': 'filter', 'chain': 'ADMIN_PREEMPTIVE', 'rule': [['fragment', true], ['comment', {'comment': 'Fragmented packets'}], ['target', 'DROP']]}
            - {'table': 'filter', 'chain': 'ADMIN_PREEMPTIVE', 'rule': [['protocol', 'tcp'], ['tcp', {'tcp-flags': ['!', 'FIN,SYN,RST,ACK', 'SYN']}], ['conntrack', {'ctstate': 'NEW'}], ['comment', {'comment': 'Invalid TCP SYN packet'}], ['target', 'DROP']]}
            - {'table': 'filter', 'chain': 'ADMIN_PREEMPTIVE', 'rule': [['protocol', 'tcp'], ['tcp', {'tcp-flags': ['FIN,SYN,RST,PSH,ACK,URG', 'FIN,SYN,RST,PSH,ACK,URG']}], ['comment', {'comment': 'Invalid TCP flags / Christmas in July'}], ['target', 'DROP']]}
            - {'table': 'filter', 'chain': 'ADMIN_PREEMPTIVE', 'rule': [['protocol', 'tcp'], ['tcp', {'tcp-flags': ['FIN,SYN,RST,PSH,ACK,URG', 'NONE']}], ['comment', {'comment': 'Invalid TCP flags / Nothing to See Here'}], ['target', 'DROP']]}
            - {'table': 'filter', 'chain': 'ADMIN_PREEMPTIVE', 'rule': [['protocol', 'tcp'], ['conntrack', {'ctstate': 'RELATED,ESTABLISHED'}], ['comment', {'comment': 'Accept TCP established traffic'}], ['target', 'ACCEPT']]}
            - {'table': 'filter', 'chain': 'ADMIN_PREEMPTIVE', 'rule': [['conntrack', {'ctstate': 'INVALID'}], ['comment', {'comment': 'Drop invalid traffic'}], ['target', 'DROP']]}
            - {'table': 'filter', 'chain': 'ADMIN_PREEMPTIVE', 'rule': [['mark', {'mark': '0xff000002/0xff00000f'}], ['set', {'match-set': ['IPS_SPOOFED_NET_LAN', 'src']}], ['comment', {'comment': 'LAN IP Spoofing'}], ['target', 'DROP']]}
            - {'table': 'filter', 'chain': 'ADMIN_PREEMPTIVE', 'rule': [['mark', {'mark': '0xff000003/0xff00000f'}], ['set', {'match-set': ['IPS_SPOOFED_NET_WAN', 'src']}], ['comment', {'comment': 'WAN IP Spoofing'}], ['target', 'DROP']]}
            - {'table': 'filter', 'chain': 'ADMIN_PREEMPTIVE', 'rule': [['mark', {'mark': '0xff000004/0xff00000f'}], ['set', {'match-set': ['IPS_SPOOFED_NET_TUN', 'src']}], ['comment', {'comment': 'TUN IP Spoofing'}], ['target', 'DROP']]}
            - {'table': 'filter', 'chain': 'ADMIN_PREEMPTIVE', 'rule': [['protocol', 'tcp'], ['conntrack', {'ctstate': 'NEW'}], ['multiport', {'dports': '135,137,138,139'}], ['comment', {'comment': 'Reject vulnerable multiport TCP services'}], ['target', 'mREJECT']]}
            - {'table': 'filter', 'chain': 'ADMIN_PREEMPTIVE', 'rule': [['mark', {'mark': '0xff000002/0xff00000f'}], ['conntrack', {'ctstate': 'NEW'}], ['hashlimit', {'hashlimit-above': '3333/sec', 'hashlimit-htable-expire': '1000', 'hashlimit-name': 'GLOBAL_NEW_CONNECTION', 'hashlimit-burst': '3000'}], ['comment', {'comment': 'New connection'}], ['target', 'DROP']]}
            - {'table': 'filter', 'chain': 'ADMIN_PREEMPTIVE', 'rule': [['mark', {'mark': '0xff000003/0xff00000f'}], ['conntrack', {'ctstate': 'NEW'}], ['hashlimit', {'hashlimit-above': '3333/sec', 'hashlimit-htable-expire': '1000', 'hashlimit-name': 'GLOBAL_NEW_CONNECTION', 'hashlimit-burst': '3000', 'hashlimit-htable-expire': '1000'}], ['comment', {'comment': 'New connection'}], ['target', 'DROP']]}
            - {'table': 'filter', 'chain': 'ADMIN_PREEMPTIVE', 'rule': [['mark', {'mark': '0xff000004/0xff00000f'}], ['conntrack', {'ctstate': 'NEW'}], ['hashlimit', {'hashlimit-above': '3333/sec', 'hashlimit-htable-expire': '1000', 'hashlimit-name': 'GLOBAL_NEW_CONNECTION', 'hashlimit-burst': '3000', 'hashlimit-htable-expire': '1000'}], ['comment', {'comment': 'New connection'}], ['target', 'DROP']]}

    CUSTOMER_POLICY:
        requires:
            - {'table': 'filter', 'chain': 'CUSTOMER_POLICY',        'create': true, 'flush': true}
            - {'table': 'filter', 'chain': 'CUSTOMER_POLICY_ACCEPT', 'create': true, 'flush': true}
            - {'table': 'filter', 'chain': 'ADMIN_POLICY',           'create': true, 'flush': false}
        rules:
            - {'table': 'filter', 'chain': 'INPUT',                  'rule': [['comment', {'comment': 'Continue in CUSTOMER_POLICY'}], ['target', 'CUSTOMER_POLICY']]}
            - {'table': 'filter', 'chain': 'FORWARD',                'rule': [['comment', {'comment': 'Continue in CUSTOMER_POLICY'}], ['target', 'CUSTOMER_POLICY']]}
            - {'table': 'filter', 'chain': 'CUSTOMER_POLICY_ACCEPT', 'rule': [['comment', {'comment': 'Continue in ADMIN_POLICY'}],    ['target', 'ADMIN_POLICY']]}

    ADMIN_POLICY:
        requires:
            - {'table': 'filter', 'chain': 'ADMIN_POLICY', 'create': true, 'flush': true}
            - {'table': 'filter', 'chain': 'POLICY_DHCP',  'create': true, 'flush': false}
            - {'table': 'filter', 'chain': 'POLICY_HTTP',  'create': true, 'flush': false}
            - {'table': 'filter', 'chain': 'POLICY_DNS',   'create': true, 'flush': false}
        rules:
            - {'table': 'filter', 'chain': 'INPUT',        'rule': [['comment', {'comment': 'Continue in ADMIN_POLICY'}], ['target', 'ADMIN_POLICY']]}
            - {'table': 'filter', 'chain': 'FORWARD',      'rule': [['comment', {'comment': 'Continue in ADMIN_POLICY'}], ['target', 'ADMIN_POLICY']]}
            - {'table': 'filter', 'chain': 'ADMIN_POLICY', 'rule': [['protocol', 'udp'], ['mark', {'mark': '0xff001010/0xff00f0f0'}], ['udp', {'dport': '67'}], ['comment', {'comment': 'Continue in POLICY_DHCP'}], ['target', 'POLICY_DHCP']]}
            - {'table': 'filter', 'chain': 'ADMIN_POLICY', 'rule': [['protocol', 'tcp'], ['mark', {'mark': '0xff001010/0xff00f0f0'}], ['multiport', {'dports': '80,443'}], ['comment', {'comment': 'Continue in POLICY_HTTP'}], ['target', 'POLICY_HTTP']]}
            - {'table': 'filter', 'chain': 'ADMIN_POLICY', 'rule': [['protocol', 'tcp'], ['mark', {'mark': '0xff001010/0xff00f0f0'}], ['multiport', {'dports': '8080,8443'}], ['comment', {'comment': 'Continue in POLICY_HTTP'}], ['target', 'POLICY_HTTP']]}
            - {'table': 'filter', 'chain': 'ADMIN_POLICY', 'rule': [['protocol', 'udp'], ['mark', {'mark': '0xff001010/0xff00f0f0'}], ['udp', {'dport': '53'}], ['comment', {'comment': 'Continue in POLICY_DNS'}], ['target', 'POLICY_DNS']]}
            - {'table': 'filter', 'chain': 'ADMIN_POLICY', 'rule': [['comment', {'comment': 'Accept'}], ['target', 'ACCEPT']]}

    ADMIN_POLICY_DHCP:
        requires:
            - {'table': 'filter', 'chain': 'POLICY_DHCP', 'create': true, 'flush': true}
        rules:
            - {'table': 'filter', 'chain': 'POLICY_DHCP', 'rule': [['protocol', 'udp'], ['mark', {'mark': '0xff000002/0xff00000f'}], ['udp', {'sport': '68', 'dport': '67'}], ['comment', {'comment': 'Accept DHCP'}], ['target', 'ACCEPT']]}
            - {'table': 'filter', 'chain': 'POLICY_DHCP', 'rule': [['protocol', 'udp'], ['mark', {'mark': '0xff021010/0xff0ff0f0'}], ['udp', {'dport': '67'}], ['comment', {'comment': 'Drop'}], ['target', 'DROP']]}

    ADMIN_POLICY_HTTP:
        requires:
            - {'table': 'filter', 'chain': 'POLICY_HTTP', 'create': true, 'flush': true}
        rules:
            - {'table': 'filter', 'chain': 'POLICY_HTTP', 'rule': [['protocol', 'tcp'], ['mark', {'mark': '0xff000003/0xff00000f'}], ['tcp', {'tcp-flags': ['FIN,SYN,RST,ACK', 'SYN']}], ['multiport', {'dports': '80,443'}], ['conntrack', {'ctstate': 'NEW'}], ['comment', {'comment': 'Accept HTTP(S) @WAN'}], ['target', 'ACCEPT']]}
            - {'table': 'filter', 'chain': 'POLICY_HTTP', 'rule': [['protocol', 'tcp'], ['mark', {'mark': '0xff000003/0xff00000f'}], ['tcp', {'tcp-flags': ['FIN,SYN,RST,ACK', 'SYN']}], ['multiport', {'dports': '8080,8443'}], ['conntrack', {'ctstate': 'NEW'}], ['comment', {'comment': 'Accept HTTP(S) @WAN'}], ['target', 'ACCEPT']]}
            - {'table': 'filter', 'chain': 'POLICY_HTTP', 'rule': [['protocol', 'tcp'], ['mark', {'mark': '0xff021010/0xff0ff0f0'}], ['multiport', {'dports': '80,443'}], ['comment', {'comment': 'Drop'}], ['target', 'DROP']]}
            - {'table': 'filter', 'chain': 'POLICY_HTTP', 'rule': [['protocol', 'tcp'], ['mark', {'mark': '0xff021010/0xff0ff0f0'}], ['multiport', {'dports': '8080,8443'}], ['comment', {'comment': 'Drop'}], ['target', 'DROP']]}

    ADMIN_POLICY_DNS:
        requires:
            - {'table': 'filter', 'chain': 'POLICY_DNS',                  'create': true, 'flush': true}
            - {'table': 'filter', 'chain': 'POLICY_DNS',                  'create': true, 'flush': true}
            - {'table': 'filter', 'chain': 'POLICY_DNS_LAN',              'create': true, 'flush': true}
            - {'table': 'filter', 'chain': 'POLICY_DNS_WAN',              'create': true, 'flush': true}
            - {'table': 'filter', 'chain': 'POLICY_DNS_TUN',              'create': true, 'flush': true}
            - {'table': 'filter', 'chain': 'POLICY_DNS_LAN_BLACKLIST',    'create': true, 'flush': true}
            - {'table': 'filter', 'chain': 'POLICY_DNS_LAN_GLOBAL_LIMIT', 'create': true, 'flush': true}
            - {'table': 'filter', 'chain': 'POLICY_DNS_WAN_BLACKLIST',    'create': true, 'flush': true}
            - {'table': 'filter', 'chain': 'POLICY_DNS_WAN_WHITELIST',    'create': true, 'flush': true}
            - {'table': 'filter', 'chain': 'POLICY_DNS_WAN_GREYLIST',     'create': true, 'flush': true}
            - {'table': 'filter', 'chain': 'POLICY_DNS_WAN_WKGREYLIST',   'create': true, 'flush': true}
            - {'table': 'filter', 'chain': 'POLICY_DNS_WAN_GLOBAL_LIMIT', 'create': true, 'flush': true}
            - {'table': 'filter', 'chain': 'POLICY_DNS_WAN_DOMAIN_LIMIT', 'create': true, 'flush': true}
        rules:
            - {'table': 'filter', 'chain': 'POLICY_DNS',                  'rule': [['protocol', 'udp'], ['mark', {'mark': '0xff000002/0xff00000f'}], ['udp', {'dport': '53'}], ['comment', {'comment': 'Continue in POLICY_DNS_LAN'}], ['target', 'POLICY_DNS_LAN']]}
            - {'table': 'filter', 'chain': 'POLICY_DNS',                  'rule': [['protocol', 'udp'], ['mark', {'mark': '0xff000003/0xff00000f'}], ['udp', {'dport': '53'}], ['comment', {'comment': 'Continue in POLICY_DNS_WAN'}], ['target', 'POLICY_DNS_WAN']]}
            - {'table': 'filter', 'chain': 'POLICY_DNS',                  'rule': [['protocol', 'udp'], ['mark', {'mark': '0xff000004/0xff00000f'}], ['udp', {'dport': '53'}], ['comment', {'comment': 'Continue in POLICY_DNS_TUN'}], ['target', 'POLICY_DNS_TUN']]}

            - {'table': 'filter', 'chain': 'POLICY_DNS_LAN',              'rule': [['comment', {'comment': 'Apply blacklist'}], ['target', 'POLICY_DNS_LAN_BLACKLIST']]}
            - {'table': 'filter', 'chain': 'POLICY_DNS_LAN',              'rule': [['comment', {'comment': 'Apply global limitation'}], ['target', 'POLICY_DNS_LAN_GLOBAL_LIMIT']]}
            - {'table': 'filter', 'chain': 'POLICY_DNS_LAN',              'rule': [['comment', {'comment': 'Should not be here'}], ['target', 'DROP']]}
            - {'table': 'filter', 'chain': 'POLICY_DNS_LAN_GLOBAL_LIMIT', 'rule': [['hashlimit', {'hashlimit-upto': '200/sec', 'hashlimit-htable-expire': '1000', 'hashlimit-name': 'DNS_LAN', 'hashlimit-burst': '300'}], ['comment', {'comment': 'Accept LAN traffic'}], ['target', 'ACCEPT']]}
            - {'table': 'filter', 'chain': 'POLICY_DNS_LAN_GLOBAL_LIMIT', 'rule': [['comment', {'comment': 'DNS LAN rate exceeded'}], ['target', 'DROP']]}
            - {'table': 'filter', 'chain': 'POLICY_DNS_TUN',              'rule': [['comment', {'comment': 'Drop DNS @TUN'}], ['target', 'DROP']]}

            - {'table': 'filter', 'chain': 'POLICY_DNS_WAN',              'rule': [['comment', {'comment': 'Apply blacklist'}], ['target', 'POLICY_DNS_WAN_BLACKLIST']]}
            - {'table': 'filter', 'chain': 'POLICY_DNS_WAN',              'rule': [['comment', {'comment': 'Apply domain limitation'}], ['target', 'POLICY_DNS_WAN_DOMAIN_LIMIT']]}
            - {'table': 'filter', 'chain': 'POLICY_DNS_WAN',              'rule': [['set', {'match-set': ['IPS_DNS_WHITELIST', 'src']}], ['comment', {'comment': 'Apply whitelist'}], ['target', 'POLICY_DNS_WAN_WHITELIST']]}
            - {'table': 'filter', 'chain': 'POLICY_DNS_WAN',              'rule': [['set', {'match-set': ['IPS_DNS_WKGREYLIST', 'src']}], ['comment', {'comment': 'Apply wellknown greylist'}], ['target', 'POLICY_DNS_WAN_WKGREYLIST']]}
            - {'table': 'filter', 'chain': 'POLICY_DNS_WAN',              'rule': [['comment', {'comment': 'Apply greylist'}], ['target', 'POLICY_DNS_WAN_GREYLIST']]}
            - {'table': 'filter', 'chain': 'POLICY_DNS_WAN',              'rule': [['comment', {'comment': 'Should not be here'}], ['target', 'DROP']]}
            - {'table': 'filter', 'chain': 'POLICY_DNS_WAN_BLACKLIST',    'rule': [['set', {'match-set': ['IPS_DNS_BLACKLIST', 'src']}], ['comment', {'comment': 'Drop blacklist DNS source'}], ['target', 'DROP']]}
            - {'table': 'filter', 'chain': 'POLICY_DNS_WAN_BLACKLIST',    'rule': [['u32', {'u32': '0x1c&0xf800=0x8000'}], ['conntrack', {'ctstate': 'NEW'}], ['comment', {'comment': 'DNS unexpected response'}], ['target', 'DROP']]}
            - {'table': 'filter', 'chain': 'POLICY_DNS_WAN_DOMAIN_LIMIT', 'rule': [['string', {'to': '65535', 'hex-string': '|07|in-addr|04|arpa|00|', 'algo': 'bm'}], ['comment', {'comment': 'Accept SOA record'}], ['target', 'RETURN']]}
            - {'table': 'filter', 'chain': 'POLICY_DNS_WAN_DOMAIN_LIMIT', 'rule': [['string', {'to': '65535', 'hex-string': '|03|gwa|04|demo|00|', 'algo': 'bm'}], ['comment', {'comment': 'Accept SOA record'}], ['target', 'RETURN']]}
            - {'table': 'filter', 'chain': 'POLICY_DNS_WAN_DOMAIN_LIMIT', 'rule': [['comment', {'comment': 'Drop !SOA allowed records'}], ['target', 'DROP']]}
            - {'table': 'filter', 'chain': 'POLICY_DNS_WAN_GLOBAL_LIMIT', 'rule': [['hashlimit', {'hashlimit-upto': '200/sec', 'hashlimit-htable-expire': '1000', 'hashlimit-name': 'DNS_WAN_GREYLIST', 'hashlimit-burst': '300'}], ['comment', {'comment': 'Accept Non-SLA traffic'}], ['target', 'ACCEPT']]}
            - {'table': 'filter', 'chain': 'POLICY_DNS_WAN_GLOBAL_LIMIT', 'rule': [['comment', {'comment': 'Drop excess'}], ['target', 'DROP']]}
            - {'table': 'filter', 'chain': 'POLICY_DNS_WAN_GREYLIST',     'rule': [['hashlimit', {'hashlimit-upto': '25/sec', 'hashlimit-htable-expire': '1000', 'hashlimit-name': 'DNS_WAN_GREYLIST', 'hashlimit-burst': '50'}], ['comment', {'comment': 'Best effort Greylist'}], ['target', 'POLICY_DNS_WAN_GLOBAL_LIMIT']]}
            - {'table': 'filter', 'chain': 'POLICY_DNS_WAN_GREYLIST',     'rule': [['comment', {'comment': 'Drop excess in Greylist'}], ['target', 'DROP']]}
            - {'table': 'filter', 'chain': 'POLICY_DNS_WAN_WHITELIST',    'rule': [['hashlimit', {'hashlimit-upto': '180/sec', 'hashlimit-htable-expire': '1000', 'hashlimit-name': 'DNS_WAN_WHITELIST', 'hashlimit-mode': 'srcip', 'hashlimit-burst': '200'}], ['comment', {'comment': 'SLA Whitelist'}], ['target', 'ACCEPT']]}
            - {'table': 'filter', 'chain': 'POLICY_DNS_WAN_WHITELIST',    'rule': [['comment', {'comment': 'Continue as WK-Greylist'}], ['target', 'POLICY_DNS_WAN_WKGREYLIST']]}
            - {'table': 'filter', 'chain': 'POLICY_DNS_WAN_WKGREYLIST',   'rule': [['hashlimit', {'hashlimit-upto': '75/sec', 'hashlimit-htable-expire': '1000', 'hashlimit-name': 'DNS_WAN_WKGREYLIST', 'hashlimit-burst': '100'}], ['comment', {'comment': 'Preferred WK-Greylist'}], ['target', 'POLICY_DNS_WAN_GLOBAL_LIMIT']]}
            - {'table': 'filter', 'chain': 'POLICY_DNS_WAN_WKGREYLIST',   'rule': [['comment', {'comment': 'Continue as Greylist'}], ['target', 'POLICY_DNS_WAN_GREYLIST']]}